# Fixing the Logout Functionality Error

## The Problem

When clicking the "Logout" button in the extension, two errors occur:

1. Client-side error: `ReferenceError: stopTokenChecking is not defined`
2. Server-side error: `POST /api/auth/oauth/v2/logout?user_id=... 405 Method Not Allowed`

## Solution Overview

We need to fix both the client-side and server-side issues:

1. **Client-side fix**: Add the missing `stopTokenChecking` function to the background.js file
2. **Server-side fix**: Add a POST endpoint for logout in addition to the existing GET endpoint

## Server-Side Fix Instructions

### Option 1: Manual Fix (Most Reliable)

1. Open the file: `app/api/endpoints/oauth_multi.py`
2. Find the existing GET logout endpoint (look for `@router.get("/logout")`)
3. Find the end of that function (the closing brace `}`)
4. Add the following code immediately after the closing brace:

```python
@router.post("/logout")
async def logout_post(
    user_id: str,
    db: Session = Depends(get_db)
):
    """Logout and invalidate OAuth token for a user via POST request"""
    # This simply calls the same implementation as the GET endpoint
    return await logout(user_id=user_id, db=db)
```

### Option 2: Use the Python Script

Run the following command in the python-server directory:

```bash
python apply_logout_fix.py
```

This script will:
1. Attempt to add the POST endpoint automatically
2. Create a backup of the original file
3. Generate the necessary client-side fix too

### Option 3: Use the PowerShell Script (Fixed Version)

Run the following command in the python-server directory:

```powershell
.\apply_logout_fix_new.ps1
```

This improved script is more reliable than the original version.

## Client-Side Fix Instructions

1. Add the following function to the background.js file of your extension right before the `performLogout` function:

```javascript
/**
 * Stop periodic token checking
 */
function stopTokenChecking() {
    console.log('Stopping periodic token checking');
    if (self.tokenCheckIntervalId) {
        clearInterval(self.tokenCheckIntervalId);
        self.tokenCheckIntervalId = null;
    }
}
```

2. The full function should be available in the `edge-extension/background_fix.js` file that was generated by the fix scripts.

## Alternative Client-Side Fix

If you can't modify the extension code, you can adapt the server to accept GET requests:

1. In `background.js`, find the fetch call in the `performLogout` function.
2. Change:
   ```javascript
   await fetch(`${API_BASE_URL}/auth/oauth/v2/logout?user_id=${encodeURIComponent(tokenState.userId)}`, {
       method: 'POST'
   });
   ```
   
   To:
   ```javascript
   await fetch(`${API_BASE_URL}/auth/oauth/v2/logout?user_id=${encodeURIComponent(tokenState.userId)}`, {
       method: 'GET'
   });
   ```

## After Applying the Fix

1. Restart your FastAPI server
2. Reload your browser extension

## Testing the Fix

After applying both fixes:

1. Open the extension
2. Click the "Logout" button
3. Verify no errors appear in the browser console
4. Check server logs to ensure the POST request is processed correctly

## Related Files

- `python_logout_handler.py`: A utility script for handling logout operations
- `cleanup_specific_token.py`: A script to manually remove tokens for specific users
- `post_logout_endpoint.py`: Contains just the code for the POST endpoint to add
- `background_fix.js`: Contains the missing `stopTokenChecking` function
